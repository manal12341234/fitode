stopifnot(require("testthat"), require("fitode"))

context("methods tests")
test_that("SI model", {
    harbin <- structure(list(week = 2:18,
        Deaths = c(2, 7, 2, 6, 12, 68, 91,
            126, 229, 250, 212, 161, 101, 108, 46, 40, 14)),
        .Names = c("week", "Deaths"),
        row.names = c(NA, -17L),
        class = "data.frame")

    SI_model <- new("model.ode",
        name = "SI",
        model = list(
            S ~ - beta*S*I/N,
            I ~ beta*S*I/N - gamma*I
        ),
        initial = list(
            S ~ N * (1 - i0),
            I ~ N * i0
        ),
        par=c("beta", "gamma", "N", "i0")
    )

    start <- c(beta=2, gamma=1, N=1e4, i0=1e-3, k=10)

    ff <- fitode(Deaths~gamma*I,
        start=start,
        model=SI_model, loglik=select_model("nbinom"),
        data=harbin,
        tcol="week",
        links = list(
            beta="log",
            gamma="log",
            N="log",
            i0="logit"
        )
    )

    all.equal(
        coef(ff),
        structure(c(1.85307052750156, 1.08617307995252, 2165.99479604132,
            0.000480015158752901, 35.9904749078504),
            .Names = c("beta", "gamma", "N", "i0", "k")))

    all.equal(
        coef(ff, "fitted"),
        structure(c(0.61684400783178, 0.0826605826183551, 7.68063502499171,
            -7.64121274342288, 3.58325431755404),
            .Names = c("log.beta", "log.gamma", "log.N", "logit.i0", "log.k")))

    all.equal(
        logLik(ff),
        -67.6513175110966
    )

    all.equal(
        predict(ff, level=0.95),
        structure(list(times = 2:18, mean = c(1.13019251456561, 2.42819273702616,
                5.19760815424427, 11.0380373957422, 23.0546330089944, 46.5397380678389,
                87.9253059145104, 147.791742265228, 208.362601891117, 237.36965774247,
                220.467892767243, 174.478185792861, 123.7464099276, 81.8622635380461,
                51.8929582439587, 32.060185078553, 19.5047497860493),
            `2.5 %` = c(0.375602754021735,
                1.09956084360443, 2.95543611264118, 7.44488359122118, 17.4826218947431,
                37.2448287376136, 70.4022719997767, 118.236900402546, 171.234181702553,
                198.136864564867, 180.658626073417, 141.604500121847, 101.942658466743,
                68.1813971255621, 41.788595780247, 23.6227737440955, 12.5766131301338),
            `97.5 %` = c(1.88478227510948, 3.75682463044788, 7.43978019584736,
                14.6311912002632, 28.6266441232456, 55.8346473980643, 105.448339829244,
                177.346584127911, 245.491022079682, 276.602450920074, 260.27715946107,
                207.351871463875, 145.550161388457, 95.5431299505301, 61.9973207076703,
                40.4975964130106, 26.4328864419647)),
            .Names = c("times", "mean",
                "2.5 %", "97.5 %"),
            row.names = c(NA, -17L),
            class = "data.frame")
    )
})
