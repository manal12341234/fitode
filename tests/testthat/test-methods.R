stopifnot(require("testthat"), require("fitode"))

context("methods tests")
test_that("SI model", {
    harbin <- structure(list(week = 2:18,
        Deaths = c(2, 7, 2, 6, 12, 68, 91,
            126, 229, 250, 212, 161, 101, 108, 46, 40, 14)),
        .Names = c("week", "Deaths"),
        row.names = c(NA, -17L),
        class = "data.frame")

    SI_model <- new("model.ode",
        name = "SI",
        model = list(
            S ~ - beta*S*I/N,
            I ~ beta*S*I/N - gamma*I
        ),
        initial = list(
            S ~ N * (1 - i0),
            I ~ N * i0
        ),
        par=c("beta", "gamma", "N", "i0")
    )

    start <- c(beta=2, gamma=1, N=1e4, i0=1e-3, k=10)

    ff <- fitode(Deaths~gamma*I,
        start=start,
        model=SI_model, loglik=select_model("nbinom"),
        data=harbin,
        tcol="week",
        links = list(
            beta="log",
            gamma="log",
            N="log",
            i0="logit"
        )
    )

    all.equal(
        coef(ff),
        structure(c(1.85303165493638, 1.08612757555308, 2165.9356324578,
            0.000480044486755712, 35.9866138522355),
            .Names = c("beta", "gamma", "N", "i0", "k")))

    all.equal(
        coef(ff, "fitted"),
        structure(c(0.616823030231449, 0.0826186874973194, 7.6806077098792,
            -7.64115161787087, 3.58314703186953),
            .Names = c("log.beta", "log.gamma", "log.N", "logit.i0", "log.k")))

    all.equal(
        logLik(ff),
        -67.6513233166266
    )

    all.equal(
        predict(ff, level=0.95),
        structure(list(times = 2:18, mean = c(1.12929621460762, 2.42669090883306,
                5.19529954008442, 11.0350412831892, 23.0522173606021, 46.5418041428741,
                87.9387928215656, 147.819696620549, 208.389945598917, 237.373074989252,
                220.448068844748, 174.454846391573, 123.732658849708, 81.8591619543988,
                51.8964828710596, 32.0663512754833, 19.5111223558432),
            `2.5 %` = c(0.374831359362622, 1.09812248252677, 2.95303901694298, 7.44160058045885, 17.4796722080732,
                37.2444238450985, 70.4063454680975, 118.250020891845, 171.25403247583,
                198.131513228149, 180.623307482592, 141.572958219239, 101.928969285078,
                68.179370423689, 41.7884503401307, 23.6216415147765, 12.5747866664963),
            `97.5 %` = c(1.88376106985262, 3.75525933513934, 7.43756006322587,
                14.6284819859196, 28.6247625131309, 55.8391844406497, 105.471240175034,
                177.389372349253, 245.525858722003, 276.614636750355, 260.272830206905,
                207.336734563907, 145.536348414337, 95.5389534851086, 62.0045154019886,
                40.5110610361901, 26.4474580451901)),
            .Names = c("times", "mean", "2.5 %", "97.5 %"),
            row.names = c(NA, -17L), class = "data.frame")
    )
})
