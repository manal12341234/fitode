stopifnot(require("testthat"), require("fitode"))

context("basic tests")
test_that("SI model", {
    harbin <- structure(list(week = 2:18,
        Deaths = c(2, 7, 2, 6, 12, 68, 91,
            126, 229, 250, 212, 161, 101, 108, 46, 40, 14)),
        .Names = c("week", "Deaths"),
        row.names = c(NA, -17L),
        class = "data.frame")

    SI_model <- new("model.ode",
        name = "SI",
        model = list(
            S ~ - beta*S*I/N,
            I ~ beta*S*I/N - gamma*I
        ),
        initial = list(
            S ~ N * (1 - i0),
            I ~ N * i0
        ),
        par=c("beta", "gamma", "N", "i0")
    )

    start <- c(beta=2, gamma=1, N=1e4, i0=1e-3, log.k=2)

    ff <- fitode(Deaths~gamma*I,
        start=start,
        model=SI_model, loglik=select_model("nbinom"),
        data=harbin,
        tcol="week",
        links = list(
            beta="log",
            gamma="log",
            N="log",
            i0="logit"
        )
    )

    all.equal(
        coef(ff),
        structure(c(1.85425138592436, 1.0875219132783, 2167.35674255335,
            0.000479494918160478, 3.58338623078509),
            .Names = c("beta", "gamma", "N", "i0", "log.k")))

    all.equal(
        coef(ff, "fitted"),
        structure(c(0.61748104906548, 0.0839016339186521, 7.68126361306944,
            -7.6422976519898, 3.58338623078509),
            .Names = c("log.beta", "log.gamma", "log.N", "logit.i0", "log.k")))

    all.equal(
        logLik(ff),
        -67.6513223662801
    )

    all.equal(
        predict(ff, level=0.95),
        structure(list(times = 2:18,
            mean = c(1.13019251456561, 2.42819273702616,
                5.19760815424427, 11.0380373957422, 23.0546330089944, 46.5397380678389,
                87.9253059145104, 147.791742265228, 208.362601891117, 237.36965774247,
                220.467892767243, 174.478185792861, 123.7464099276, 81.8622635380461,
                51.8929582439587, 32.060185078553, 19.5047497860493),
            `2.5 %` = c(0.374889670624742, 1.09845372135939, 2.95395623482326, 7.44347480014338,
                17.4822117175044, 37.2439284142553, 70.393363894146, 118.219639761447, 171.22667088229,
                198.134546893163, 180.635810823764, 141.578467105874, 101.930702361277,
                68.1805328379916, 41.7871013451681, 23.6172823559793, 12.5695496098402),
            `97.5 %` = c(1.88549535850648, 3.75793175269292, 7.44126007366529,
                14.6325999913411, 28.6270543004843, 55.8355477214226, 105.457247934875,
                177.36384476901, 245.498532899944, 276.604768591778, 260.299974710722,
                207.377904479848, 145.562117493923, 95.5439942381006, 61.9988151427492,
                40.5030878011268, 26.4399499622583)),
            .Names = c("times", "mean", "2.5 %", "97.5 %"),
            row.names = c(NA, -17L), class = "data.frame")
    )








})
